<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../input-picker-pattern/input-pattern.html">

<script>
  /**
   * mixin to create a text-input
   *
   * @appliesMixin InputPattern
   *
   * @mixinFunction
   * @polymer
   */
  const TextInputMixin = (superClass) => { // eslint-disable-line no-unused-vars

    return class extends InputPattern(superClass) { // eslint-disable-line no-undef

      static get styleTemplate() {
        return `
          ${super.styleTemplate || ''}
          #minsize,
          #size,
          #input {
            @apply --text-input;
            margin: 0;
            min-width: 1ch;
          }
          :host(:focus) #input,
          :host(:hover) #input,
          #input:hover,
          #input:focus {
            @apply --text-input-focus;
          }
          :host([invalid]) #input {
            @apply --text-input-invalid;
          }
          :host([disabled]) #input {
            @apply --text-input-disabled;
          }
          #input::-webkit-input-placeholder,
          #input::placeholder {
            @apply --text-input-placeholder;
          }
        `;
      }

      static get inputTemplate() {
        return `
          <input id="input"
            type="[[type]]"
            value="{{_input::input}}"
            placeholder="[[placeholder]]"
            pattern="[[pattern]]"
            disabled="[[disabled]]"
            required="[[required]]"
            autocomplete$="[[_computeAutocompleteAttribute(autocomplete)]]"
            spellcheck$="[[_computeSpellcheckAttribute(spellcheck)]]">
        `;
      }

      static get properties() {
        return {

          /**
           * regular expression pattern of the input
           * @type {string}
           */
          pattern: {
            type: String,
            notify: true,
            observer: '_patternChanged'
          },

          /**
           * if `true`, autocomplete is enabled
           */
          autocomplete: {
            type: Boolean,
            value: false
          },

          /**
           * if `true`, spellcheck is enabled
           */
          spellcheck: {
            type: Boolean,
            value: false
          }
        }
      }

      static get observers() {
        return [
          '_computeInvalid(required, _input)'
        ]
      }

      _computeInvalid() {
        return this.validate();
      }

      validate() {
        if (this.disabled) {
          return false;
        }
        if (!(this._validationRegExp && this._validationRegExp.exec(this._input) === null) && !(this.required && !this._input)) {
          return true;
        } else if (!(this._validationRegExp && this._validationRegExp.exec(this.value) === null) && !(this.required && !this.value)) {
          return true;
        }
        return false;
      }

      _patternChanged(pattern) {
        if (!pattern) {
          this._validationRegExp = null;
          return;
        }
        this._validationRegExp = new RegExp(pattern);
        this.validate();
      }

      _inputChanged(input) {
        if (input === undefined) return;

        if (!(this._validationRegExp && this._validationRegExp.exec(input) === null)) {
          this.value = input;
        }
      }

      _valueChanged(value, oldValue) {
        if (value === undefined) return;

        if (!(this._validationRegExp && this._validationRegExp.exec(value) === null)) {
          this._input = value;
          this._debouncedComputeWidth();
        } else if (oldValue !== undefined && this._validationRegExp.exec(oldValue) !== null) {
          this.value = oldValue;
          this._debouncedComputeWidth();
        }
      }

      _computeSpellcheckAttribute(spellcheck) {
        return spellcheck ? 'true' : 'false';
      }

      _computeAutocompleteAttribute(autocomplete) {
        return autocomplete ? 'on' : 'off';
      }

    }
  }

  window.TextInputMixin = TextInputMixin;
</script>

<dom-module id="text-input">
  <script>
    /**
     *  `text-input` is an element that can:
     * * guarantee **live**-data to be valid
     * * be styled easily and in unified way
     *
     * Example:
     * ```html
     * <text-input step="2" min="-20" max="140" pad-length="2"></text-input>
     * ```
     *
     * It sizes automatically. Use `key-up` and `key-down` to increment the value. If `step` is given, the value is a **multiple** of `step`.
     *
     * ### Styling
     * Custom property                   | Description                                  | Default
     * ----------------------------------|----------------------------------------------|--------------------
     * `--input-color`                   | color of the input                             | inherit
     * `--input-background`              | background of the input                        | transparent
     * `--input-border-width`            | border width of the input                      | thin
     * `--input-border-style`            | border style of the input                      | dotted
     * `--input-border-color`            | border color of the input                      | transparent
     * `--input-padding`                 | padding of the input                           | 0.2em
     * `--input-border-radius`           | border-radius of the input                     | 0.25em
     * `--input-transition`              | transition of the input                        | background 250ms cubic-bezier(0.6, 1, 0.2, 1)
     * `--input-allign`                  | text-allign of the input input                 | center
     * `--input-cursor`                  | cursor of the input input                      | initial
     * `--input-focus-color`             | color of the focussed and hovered input        | inherit
     * `--input-focus-background`        | background of the focussed and hovered input   | rgba(0, 0, 0, 0.16)
     * `--input-focus-border-style`      | border style of the focussed and hovered input | dotted
     * `--input-focus-border-color`      | border color of the focussed and hovered input | currentColor
     * `--input-invalid-color`           | color of the invalid input                     | inherit
     * `--input-invalid-background`      | background of the invalid input                | rgba(255, 0, 0, 0.16)
     * `--input-invalid-border-style`    | border style of the invalid input              | dotted
     * `--input-invalid-border-color`    | border color of the invalid input              | rgba(255, 0, 0, 0.5)
     * `--input-disabled-color`          | color of the disabled input                    | inherit
     * `--input-disabled-background`     | background of the disabled input               | transparent
     * `--input-disabled-font-style`     | font-style of the disabled input               | italic
     * `--input-disabled-opacity`        | opacity of the disabled input                  | 1
     * `--input-placeholder-color`       | color of the placeholder                       | inherit
     * `--input-placeholder-opacity`     | opacity of the placeholder                     | 0.75
     * `--input-placeholder-align`       | text-allign of the placeholder                 | center
     * `--input-selection-color`         | color of the selected text                     | inherit
     * `--input-selection-background`    | background of the selected text                | rgba(255, 255, 255, 0.5)
     * `--input-style`                   | style of the input                             | {}
     * `--input-focus`                   | style of the focussed and hovered input        | {}
     * `--input-invalid`                 | style of the invalid input                     | {}
     * `--input-placeholder`             | style of the placeholder                       | {}
     *
     * ```css
     * :host {
     *   --input-disabled-color: grey;
     *   --input-focus-background: rgba(0,0,0,0.25);
     *   --input-focus: {
     *     font-weight: bold;
     *   };
     *   --input-placeholder-color: pink;
     * }
     * ```
     * @polymer
     * @customElement
     *
     * @appliesMixin TextInputMixin
     *
     * @demo demo/index.html
     * @demo demo/iron-form.html in a form
     **/
    class TextInput extends TextInputMixin(Polymer.Element) { // eslint-disable-line no-undef

      static get is() {
        return 'text-input';
      }

    }

    window.customElements.define(TextInput.is, TextInput);
  </script>
</dom-module>
