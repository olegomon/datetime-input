<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../property-mixins/range-mixin.html">
<link rel="import" href="../input-picker-pattern/form-element-mixin.html">
<link rel="import" href="integer-input.html">

<script>
  /**
   * mixin to create a number-input
   *
   * @appliesMixin IntegerInputMixin
   *
   * @mixinFunction
   * @polymer
   */
  const NumberInputMixin = (superClass) => { // eslint-disable-line no-unused-vars

    return class extends IntegerInputMixin(superClass) {  // eslint-disable-line no-undef

      static get properties() {
        return {
          /**
           * if true the value string is percent-format
           * notice: min, max and step are not in percent (so e.g. if step is 0.001, it means that the step is 0.1%)
           * @type {string}
           */
          inPercent: {
            type: Boolean,
            value: false,
            observer: '_unitChanged'
          },

          /**
           * unit of the value
           * @type {string}
           */
          unit: {
            type: String,
            observer: '_unitChanged'
          },

          /**
           * The current locale to set the decimal-separator automatically
           */
          locale: {
            type: String,
            value: window.navigator.language,
            observer: '_localeChanged'
          },

          /**
           * Separator for local decimal values
           * @type {string}
           */
          decimalSeparator: {
            type: String
          },

          /**
           * minimum digits right to the decimal separator
           * @type {number}
           */
          minimumFractionDigits: {
            type: Number,
            computed: '_computeMinimumFractionDigits(step, min, max, inPercent)'
          },

          /**
           * regular expression to detect the decimal separator
           * @type {RegExp}
           */
          _regExpDecimalSeparator: {
            type: RegExp,
            computed: '_computeRegExpDecimalSeparator(decimalSeparator)'
          },

          /**
           * regular expression to replace non-numeric parts of a number string
           * @type {RegExp}
           */
          _regExpNotInNumber: {
            type: RegExp,
            computed: '_computeRegExpNotInNumber(decimalSeparator)'
          }
        }
      }

      _computeMinimumFractionDigits(step, min, max, inPercent) {
        if (inPercent) {
          min = this._safeMult(min || 0, 100);
          max = this._safeMult(max || 0, 100);
          step = this._safeMult(step || 0.01, 100);
        }

        min = '' + (Math.abs(min) || '');
        max = '' + (Math.abs(max) || '');
        step = '' + step;

        return ['0', step, min, max].reduce( (acc, curr) => {
          const pos = curr.indexOf('.');
          return Math.max((pos < 0) ? 0 : (curr.length - 1 - pos), acc);
        });
      }

      _computeMinimumIntegerDigits(autoPadding, padLength, min, max, step, inPercent) {
        if (inPercent === true) {
          min = Math.round(min * 100);
          max = Math.round(max * 100);
          step = Math.round(step * 100);
        } else {
          min = Math.round(min);
          max = Math.round(max);
          step = Math.round(step);
        }
        min = '' + (Math.abs(min) || 0);
        max = '' + (Math.abs(max) || 0);
        step = '' + (Math.abs(step) || 0);

        if (autoPadding) {
          return Math.max((padLength || 1), step.length, min.length, max.length);
        }
        return padLength || 1;
      }

      _computeLongestStatic(minlength, alwaysSign, minimumIntegerDigits, minimumFractionDigits) {
        return Math.max(minlength || 1, this._computeChWidth((!alwaysSign && (this.min < 0 || this.max < 0) ? '-' : '') + this.formatNumber(Math.pow(10, minimumIntegerDigits - 1) + Math.pow(10, -(minimumFractionDigits || 0)))));
      }

      _computeRegExpDecimalSeparator(decimalSeparator) {
        return new RegExp('\\' + decimalSeparator, 'g');
      }

      _computeRegExpNotInNumber(decimalSeparator) {
        return new RegExp('[^\\d-+\\' + decimalSeparator + ']', 'g');
      }

      _unitChanged() {
        if (this.inPercent) {
          if (this.unit !== '%') {
            this.unit = '%';
            return;
          }
          this._unitEmLength = 1.125;
          this._unitChLength = 0;
          if (this.value !== undefined) {
            this.$.input.value = this.formatNumber(this._safeMult(this.value, 100)) + '\u202F%';
          }
        } else if (this.unit === '%') {
          this.unit = '';
          return;
        } else {
          if (this.value !== undefined) {
            this.$.input.value = this.formatNumber(this.value) + (this.unit ? ('\u202F' + this.unit) : '');
          }
          this._unitEmLength = (this._computeEmWidth(this.unit) || 0) + 0.125;
          this._unitChLength = (this._computeChWidth(this.unit) || 0) * this._chCorrection;
        }
        this._updateView();
      }

      _inputChanged(input, oldinput) {
        if (!input) {
          if (!isNaN(this.default)) {
            this.input = '' + this.default;
          } else {
            this.$.input.value = '';
          }
          return;
        }
        oldinput = oldinput || '';

        let newValue, oldValue, value;

        if (this.inPercent) {
          newValue = parseFloat(this._safeMult(input.replace(this._regExpNotInNumber, '').replace(this._regExpDecimalSeparator, '.'), 0.01));
          oldValue = parseFloat(this._safeMult(oldinput.replace(this._regExpNotInNumber, '').replace(this._regExpDecimalSeparator, '.'), 0.01));
        } else {
          newValue = parseFloat(input.replace(this._regExpNotInNumber, '').replace(this._regExpDecimalSeparator, '.'));
          oldValue = parseFloat(oldinput.replace(this._regExpNotInNumber, '').replace(this._regExpDecimalSeparator, '.'));
        }
        if (isNaN(oldValue)) {
          value = this._checkValue(newValue);
        } else {
          value = this._checkValue(newValue, oldValue);
        }

        input = this.formatNumber(this.inPercent ? this._safeMult(value, 100) : value);

        if (this.input !== input) {
          this.input = input;
          return;
        }

        this.$.input.value = input + (this.unit ? ('\u202F' + this.unit) : '');
        this.value = value;
      }

      _valueChanged(value, oldValue) {
        if (value === undefined) {
          if (!isNaN(this.default)) {
            this.value = this.default;
          } else {
            this.input = undefined;
          }
          return
        }

        if (isNaN(oldValue)) {
          value = this._checkValue(value);
        } else {
          value = this._checkValue(value, oldValue);
        }

        if (this.value !== value) {
          this.value = value;
          return;
        }
        const input = this.formatNumber(this.inPercent ? this._safeMult(value, 100) : value);

        this.$.input.value = input + (this.unit ? ('\u202F' + this.unit) : '');
        this.input = input;
      }

      _increm(step) {
        let value = parseFloat(this.$.input.value.replace(this._regExpNotInNumber, '').replace(this._regExpDecimalSeparator, '.'));
        let input;
        if (isNaN(value)) {
          if (!isNaN(this.startAt)) {
            input = this.startAt;
          } else if (!isNaN(this.default)) {
            input = this.default;
          } else {
            input = (this.min < 0 ? 0 : this.min || 0);
          }
        } else if (this.inPercent) {
          input = this._safeAdd(this._safeMult(value, 0.01), step);
        } else {
          input = this._safeAdd(value, step);
        }
        if (this.noClamp) {
          // still clamp to step, when incrementing
          this.value = this._checkStep(this._checkValue(input, this.value), this.step);
        } else {
          this.value = this._checkValue(input, this.value);
        }
      }

      _computeWidth(input) {
        if (this.noAutoWidth) return;

        input = input || '';

        const currLength = this._computeChWidth(input);
        const length = Math.max(this._longestStaticLength, currLength) * this._chCorrection;

        if (this.unit !== undefined) {
          this.$.input.style.width = `calc(${length + this._unitChLength}ch + ${this._unitEmLength}em)`;
        } else {
          this.$.input.style.width = `${length}ch`;
        }
      }

      _localeChanged(locale) {
        if (!(locale && Intl.NumberFormat && Intl.NumberFormat.supportedLocalesOf(locale))) {
          this.decimalSeparator = '.';
          return;
        }
        locale += '-u-nu-latn-ca-iso8601';
        const decimalSeparator = new Intl.NumberFormat(locale).format(1.2).split(/\d/g).filter(s => { return s !== ''; }).pop();
        this.decimalSeparator = decimalSeparator !== '\u202F' ? decimalSeparator : '.';
      }

      formatNumber() {
        const n = arguments[0];
        let str = '' + Math.abs(n);
        const decimalR = str.slice(str.indexOf('.')).length - 1;
        let decimalL = str.length - decimalR - 1;
        if (decimalR === 0) {
          decimalL++;
          if (this.minimumFractionDigits > 0) {
            str += '.';
          }
        }
        for (let i = 0; i < this.minimumFractionDigits - decimalR; i++) {
          str += '0';
        }
        for (let i = 0; i < this.minimumIntegerDigits - decimalL; i++) {
          str = '0' + str;
        }
        if (this.decimalSeparator !== '.') {
          str = str.replace('.', this.decimalSeparator || '.');
        }
        if (n < 0) {
          str = '-' + str;
        } else if (this.alwaysSign) {
          str = '+' + str;
        }
        return str;
      }
    }
  }
</script>

<dom-module id="number-input">
  <script>
    /**
     *  `number-input` is an element that can:
     * * prevent non numeric input
     * * guarantee **live**-data to be valid
     * * pad a value with `0` (to a specific length)
     * * size the input (according to it's length)
     * * overflow to minimum or underflow to maximum
     * * saturate to minimum or to maximum
     * * display a specified unit and size the input
     * * specify the decimal separator (the value will still be a Number object)
     * * use percent-format
     *
     * Example:
     * ```html
     * <number-input step="2" min="-20" max="140" pad-length="2"></number-input>
     * ```
     *
     * It sizes automatically. Use `key-up` and `key-down` to increment the value. If `step` is given, the value is a **multiple** of `step`.
     *
     * ### Styling
     * Custom property                   | Description                                  | Default
     * ----------------------------------|----------------------------------------------|--------------------
     * `--number-input`                  | style of the input                           | {}
     * `--number-input-focus`            | style of the focussed and hovered input      | {}
     * `--number-input-placeholder`      | style of the placeholder                     | {}
     * `--number-input-color`            | color of the input                           | inherit
     * `--number-input-background`       | background of the input                      | inherit
     * `--number-input-focus-color`      | color of the focussed and hovered input      | inherit
     * `--number-input-focus-background` | background of the focussed and hovered input | rgba(0,0,0,0.1)
     * `--number-input-disabled-color`   | color of the disabled input                  | inherit
     *
     * ```css
     * :host {
     *   --number-input-disabled-color: grey;
     *   --number-input-focus-background: rgba(0,0,0,0.25);
     *   --number-input-focus: {
     *     font-weight: bold;
     *   };
     *   --number-input-placeholder: {
     *     color: pink;
     *   };
     * }
     * ```
     * @polymer
     * @customElement
     *
     * @appliesMixin NumberInputMixin
     *
     * @demo demo/index.html
     * @demo demo/form.html Form Demo
     **/
    class NumberInput extends NumberInputMixin(Polymer.Element) {  // eslint-disable-line no-undef

      static get is() {
        return 'number-input';
      }
    }
    window.customElements.define(NumberInput.is, NumberInput);
  </script>
</dom-module>
